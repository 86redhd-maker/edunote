<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>교무행정 · 따뜻한 교사용 MVP+</title>
<meta name="description" content="교사용 진도/계획·평가/보충·행사 메모·업무·자료실 통합 데모(오프라인 단일 파일)" />
<style>
/* ================== CSS Reset & Variables ================== */
:root {
  --hue: 30;
  --accent: hsl(var(--hue), 45%, 48%);
  --accent-strong: hsl(var(--hue), 55%, 42%);
  --bg: #FAF9F6;
  --surface: #FDFBF7;
  --card: #FFFFFF;
  --text: #3E3A39;
  --muted: #7A6E66;
  --border: #E6E0DA;
  --shadow: 0 10px 28px rgba(100, 72, 40, .08);
  --radius: 16px;
  --focus: 0 0 0 3px rgba(216,168,87,.35);
  --space-1: 0.5rem;
  --space-2: 0.75rem;
  --space-3: 1rem;
  --space-4: 1.25rem;
}

[data-theme="dark"] {
  --bg: #2F2A26;
  --surface: #352F2B;
  --card: #3A3430;
  --text: #EDE9E3;
  --muted: #A29E9A;
  --border: #4A433F;
  --shadow: 0 12px 34px rgba(0,0,0,.4);
}

/* Theme presets */
body.theme-classic { --hue: 212; }
body.theme-arcade { --hue: 265; }
body.theme-soft { --hue: 170; }

/* ================== Base Styles ================== */
* { 
  box-sizing: border-box; 
  touch-action: manipulation;
}

html, body { height: 100%; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: "Pretendard", ui-rounded, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
  line-height: 1.6;
  letter-spacing: -0.2px;
  -webkit-font-smoothing: antialiased;
}

a {
  color: var(--accent-strong);
  text-decoration: none;
}
a:hover { text-decoration: underline; }

:focus-visible { outline: var(--focus); }

img, svg, video {
  max-width: 100%;
  height: auto;
}

/* ================== Layout Components ================== */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 10px 20px;
}

main {
  max-width: 1200px;
  margin: 24px auto 96px;
  padding: 0 20px;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: var(--space-3);
  margin-bottom: var(--space-3);
}

.grid {
  display: grid;
  gap: 14px;
  grid-template-columns: repeat(12, 1fr);
}

/* ================== Navigation Layouts ================== */
.navlink {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  cursor: pointer;
  font-weight: 800;
  transition: all 0.15s;
}

.navlink.active {
  background: var(--accent);
  color: #fff;
  border-color: transparent;
}

.navlink:hover {
  transform: translateY(-1px);
}

/* Classic: Top Navigation */
body.theme-classic header.top {
  position: sticky;
  top: 0;
  z-index: 40;
  background: linear-gradient(180deg, rgba(255,253,248,.85), rgba(255,253,248,.65));
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(6px);
}

body.theme-classic header.top .nav {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0 12px;
}

/* Arcade: Bottom Dock */
body.theme-arcade header.top { display: none; }

body.theme-arcade .dock {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 14px;
  z-index: 50;
  background: #ffffffee;
  border: 1px solid var(--border);
  border-radius: 14px;
  display: flex;
  gap: 6px;
  padding: 8px;
  box-shadow: var(--shadow);
}

[data-theme="dark"] .dock { background: #2f2a26ee; }

/* Soft: Left Sidebar */
body.theme-soft header.side {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: 220px;
  border-right: 1px solid var(--border);
  background: #fffaf3cc;
  backdrop-filter: blur(8px);
  z-index: 40;
}

[data-theme="dark"] body.theme-soft header.side { 
  background: #2f2a26cc; 
}

body.theme-soft .side .inner { 
  padding: 12px; 
}

body.theme-soft main { 
  margin-left: 220px; 
}

/* ================== Form Elements ================== */
.btn {
  appearance: none;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  padding: 10px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 700;
  box-shadow: var(--shadow);
  transition: 0.15s;
  min-height: 44px;
  font: inherit;
}

.btn:hover { transform: translateY(-1px); }
.btn:active { transform: translateY(0); }

.btn-primary {
  background: var(--accent-strong);
  border: 0;
  color: #fff;
  box-shadow: 0 10px 22px rgba(216,168,87,.25);
}

.input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  min-height: 44px;
  font: inherit;
}

select.input {
  color: var(--text) !important;
  background-color: var(--card) !important;
  appearance: auto !important;
  -webkit-appearance: menulist !important;
  -moz-appearance: menulist !important;
}

[data-theme="dark"] select.input {
  color: #EDE9E3 !important;
  background-color: #2F2A26 !important;
}

select.input option {
  color: #111 !important;
  background: #fff !important;
}

[data-theme="dark"] select.input option {
  color: #EDE9E3 !important;
  background: #2F2A26 !important;
}

label {
  font-size: 12px;
  color: var(--muted);
  display: block;
  margin-bottom: 6px;
}

.small {
  font-size: 12px;
  color: var(--muted);
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  border: 1px solid var(--border);
  background: var(--surface);
}

.pin {
  color: var(--accent-strong);
  font-weight: 900;
}

/* ================== Table Components ================== */
.table-wrap {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: var(--radius);
  max-width: 100%;
  padding-right: 8px;
}

.table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
}

.table th, .table td {
  border-bottom: 1px solid var(--border);
  padding: 8px;
  text-align: left;
  vertical-align: top;
  white-space: nowrap;
}

.table th {
  color: var(--muted);
  font-weight: 700;
  font-size: 12px;
}

.table tr:hover td {
  background: var(--surface);
}

.table input, .table select {
  width: 100%;
  max-width: 100%;
  height: 34px;
  box-sizing: border-box;
}

/* Specific table optimizations */
#maTable td:nth-child(1) select[data-field="mode"] {
  width: 92px;
  min-width: 88px;
  max-width: 120px;
}

#maTable td:nth-child(2) input { min-width: 200px; }
#maTable td:nth-child(6) input { min-width: 200px; }
#maTable td:nth-child(7) input { min-width: 260px; }
#maTable td:last-child button { width: 60px; }

/* ================== Widget Components ================== */
.calendar {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: var(--surface);
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
}

.calendar-grid .day-name, .calendar-grid .cell {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
  min-height: 90px;
}

.calendar-grid .day-name {
  background: #fff;
  font-weight: 700;
  text-align: center;
}

.calendar-grid .cell:nth-child(7n) {
  border-right: 0;
}

.event {
  background: #fff;
  border: 1px solid var(--border);
  border-left: 4px solid var(--accent);
  border-radius: 10px;
  padding: 6px 8px;
  margin-bottom: 6px;
  font-size: 12px;
  cursor: pointer;
}

.kanban {
  display: grid;
  gap: 12px;
  grid-template-columns: repeat(3, 1fr);
}

.column {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px;
  min-height: 240px;
}

.task {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: grab;
}

.progress {
  height: 6px;
  border-radius: 999px;
  background: #e5e7eb;
  overflow: hidden;
  margin-top: 8px;
}

.progress > span {
  display: block;
  height: 100%;
  background: var(--accent);
}

.preview {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px;
  background: var(--surface);
  max-height: 320px;
  overflow: auto;
}

.file-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
  background: #fff;
}

.file-meta {
  font-size: 12px;
  color: var(--muted);
}

.chart {
  width: 100%;
  height: 240px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--card);
  position: relative;
}

.chart canvas {
  width: 100%;
  height: 100%;
}

/* ================== Section Management ================== */
section {
  display: none;
}

section.active {
  display: block;
}

/* ================== Mobile Optimizations ================== */
.h-scroll {
  display: flex;
  gap: 0.5rem;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  padding: var(--space-2) var(--space-3);
}

.h-scroll > * {
  flex: 0 0 auto;
}

@media (max-width: 960px) {
  .grid { grid-template-columns: 1fr; }
  .kanban { grid-template-columns: 1fr; }
  body.theme-soft header.side { width: 200px; }
  body.theme-soft main { margin-left: 200px; }
  .dock { transform: translateX(-50%) scale(0.98); }
}

@media (max-width: 768px) {
  .container { padding: var(--space-3); }
  .grid { gap: var(--space-3); }
  
  /* Hide desktop navigation on mobile */
  header.top,
  header.side,
  #dock { 
    display: none !important; 
  }

  main {
    margin: 16px auto 0;
    padding-bottom: calc(56px + env(safe-area-inset-bottom));
  }

  /* Mobile table cards */
  table.responsive { border: 0; }
  table.responsive thead { display: none; }
  table.responsive tr {
    display: block;
    background: color-mix(in oklab, Canvas 98%, black 0%);
    border: 1px solid color-mix(in oklab, CanvasText 10%, transparent);
    border-radius: var(--radius);
    padding: var(--space-2) var(--space-3);
    margin-bottom: var(--space-2);
  }
  table.responsive td {
    display: grid;
    grid-template-columns: 9rem 1fr;
    padding: 0.4rem 0;
    border: 0;
    border-bottom: 1px dotted color-mix(in srgb, CanvasText 15%, transparent);
    white-space: normal;
  }
  table.responsive td:last-child { border-bottom: 0; }
  table.responsive td::before {
    content: attr(data-label);
    font-weight: 600;
    opacity: 0.75;
    padding-right: 0.75rem;
  }

  /* Mobile bottom tabbar */
  .tabbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 30;
    background: color-mix(in oklab, Canvas 92%, black 0%);
    border-top: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
    padding-bottom: env(safe-area-inset-bottom);
  }

  .tabbar ul {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    margin: 0;
    padding: 4px;
    list-style: none;
  }

  .tabbar a,
  .tabbar button {
    display: grid;
    place-items: center;
    gap: 2px;
    padding: 6px 0;
    font-size: 12px;
    line-height: 1.2;
    text-decoration: none;
    color: inherit;
    background: none;
    border: 0;
    cursor: pointer;
    min-height: 44px;
  }

  .tabbar small {
    font-size: 10px;
    opacity: 0.8;
    line-height: 1;
  }

  .tabbar .navlink.active {
    background: color-mix(in oklab, Canvas 98%, black 0%);
    border: 1px solid color-mix(in oklab, CanvasText 12%, transparent);
    border-radius: 10px;
  }
}

@supports (padding: max(0px)) {
  .safe-bottom {
    padding-bottom: max(env(safe-area-inset-bottom), 0.5rem);
  }
}

@media (max-width: 1200px) {
  .table th, .table td { 
    white-space: normal; 
  }
}
</style>
</head>

<body class="theme-classic" data-theme="light">

<!-- ================== Navigation Headers ================== -->
<!-- Top header (classic & default) -->
<header class="top" id="headerTop">
  <div class="container">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:34px;height:34px;border-radius:10px;background: var(--accent); box-shadow: var(--shadow)"></div>
        <div>
          <div style="font-weight:900">교무행정 · 따뜻한 교사용</div>
          <div class="small">오프라인 단일 파일 · localStorage 저장</div>
        </div>
      </div>
      <nav class="nav" id="navTop">
        <button class="navlink active" data-target="dash">대시보드</button>
        <button class="navlink" data-target="calendar">일정</button>
        <button class="navlink" data-target="tasks">업무</button>
        <button class="navlink" data-target="files">자료실</button>
        <button class="navlink" data-target="progress">진도</button>
        <button class="navlink" data-target="plans">계획</button>
        <button class="navlink" data-target="assess">평가·보충</button>
        <button class="navlink" data-target="minachv">보장지도</button>
        <button class="navlink" data-target="settings">설정</button>
      </nav>
    </div>
  </div>
</header>

<!-- Soft sidebar header -->
<header class="side" id="headerSide" style="display:none">
  <div class="inner">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
      <div style="width:34px;height:34px;border-radius:10px;background: var(--accent); box-shadow: var(--shadow)"></div>
      <div style="font-weight:900">교사용 허브</div>
    </div>
    <nav id="navSide" style="display:grid; gap:6px;">
      <button class="navlink active" data-target="dash">🏠 대시보드</button>
      <button class="navlink" data-target="calendar">📅 일정</button>
      <button class="navlink" data-target="tasks">🗂️ 업무</button>
      <button class="navlink" data-target="files">📁 자료실</button>
      <button class="navlink" data-target="progress">📈 진도</button>
      <button class="navlink" data-target="plans">📝 계획</button>
      <button class="navlink" data-target="assess">✅ 평가·보충</button>
      <button class="navlink" data-target="minachv">🌱 보장지도</button>
      <button class="navlink" data-target="settings">⚙️ 설정</button>
    </nav>
  </div>
</header>

<!-- Arcade bottom dock -->
<div id="dock" class="dock" style="display:none">
  <button class="navlink active" data-target="dash">대시보드</button>
  <button class="navlink" data-target="calendar">일정</button>
  <button class="navlink" data-target="tasks">업무</button>
  <button class="navlink" data-target="files">자료실</button>
  <button class="navlink" data-target="progress">진도</button>
  <button class="navlink" data-target="plans">계획</button>
  <button class="navlink" data-target="assess">평가</button>
  <button class="navlink" data-target="minachv">보장지도</button>
  <button class="navlink" data-target="settings">설정</button>
</div>

<main>
  <!-- ================== Dashboard ================== -->
  <section id="dash" class="active">
    <div class="grid">
      <div class="card" style="grid-column: span 7;">
        <h3>이번 주 수업·평가·보충·행사</h3>
        <div id="dashWeek"></div>
      </div>
      <div class="card" style="grid-column: span 5;">
        <h3>임박 업무</h3>
        <div id="dashDue"></div>
      </div>
      <div class="card" style="grid-column: span 12;">
        <h3>요약 지표</h3>
        <div class="grid">
          <div class="chart" style="grid-column: span 6;"><canvas id="chTask"></canvas></div>
          <div class="chart" style="grid-column: span 6;"><canvas id="chGap"></canvas></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Calendar ================== -->
  <section id="calendar">
    <div class="grid">
      <div class="card" style="grid-column: span 8;">
        <div class="calendar">
          <div class="calendar-header">
            <div style="display:flex; gap:6px; align-items:center;">
              <button class="btn" id="prevM">◀</button>
              <div id="monthLabel" style="font-weight:900"></div>
              <button class="btn" id="nextM">▶</button>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <select id="calFilter" class="input">
                <option value="ALL">표시: 전체</option>
                <option>수업</option><option>평가</option><option>보충</option><option>행사</option><option>업무</option>
              </select>
            </div>
          </div>
          <div class="calendar-grid" id="calGrid"></div>
        </div>
      </div>
      <div class="card" style="grid-column: span 4;">
        <h3>학교 행사</h3>
        <div style="display:grid; gap:8px;">
          <div><label>행사명</label><input class="input" id="evTitle" placeholder="수학여행, 체험학습 등"/></div>
          <div><label>날짜</label><input class="input" id="evDate" type="date"/></div>
          <div><label>설명</label><textarea class="input" id="evMemo" rows="2"></textarea></div>
          <details>
            <summary class="small">반별 특화 메모</summary>
            <div style="display:grid; gap:6px; margin-top:6px;">
              <div><input class="input" id="evClass" placeholder="예: 1-1"/></div>
              <div><input class="input" id="evClassMemo" placeholder="예: 서울 코스 10시 출발"/></div>
              <button class="btn" id="addClassMemo">추가</button>
              <div class="small" id="evClassMemoList"></div>
            </div>
          </details>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" id="addEvent">등록</button>
            <button class="btn" id="clearEvent">초기화</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Tasks ================== -->
  <section id="tasks">
    <div class="grid">
      <div class="card" style="grid-column: span 8;">
        <div class="kanban">
          <div class="column" data-col="todo">
            <div style="display:flex; justify-content:space-between; align-items:center;"><strong>할 일</strong><span class="small" id="cntTodo"></span></div>
            <div class="col-body" id="col-todo"></div>
          </div>
          <div class="column" data-col="doing">
            <div style="display:flex; justify-content:space-between; align-items:center;"><strong>진행</strong><span class="small" id="cntDoing"></span></div>
            <div class="col-body" id="col-doing"></div>
          </div>
          <div class="column" data-col="done">
            <div style="display:flex; justify-content:space-between; align-items:center;"><strong>완료</strong><span class="small" id="cntDone"></span></div>
            <div class="col-body" id="col-done"></div>
          </div>
        </div>
      </div>
      <div class="card" style="grid-column: span 4;">
        <h3>업무 추가</h3>
        <div style="display:grid; gap:8px;">
          <div><label>업무명</label><input class="input" id="taskTitle" placeholder="가정통신문 배포"/></div>
          <div style="display:flex; gap:8px;">
            <div style="flex:1"><label>역할</label><select id="taskRole" class="input"><option>담임</option><option>부장</option><option>교과</option><option>행정</option></select></div>
            <div style="flex:1"><label>마감</label><input class="input" id="taskDue" type="date"/></div>
          </div>
          <div><label>진행률</label><input id="taskProg" type="range" min="0" max="100" value="0" oninput="byId('progVal').innerText=this.value+'%'"/><div class="small">현재: <span id="progVal">0%</span></div></div>
          <div><label>메모</label><textarea id="taskMemo" rows="3" class="input"></textarea></div>
          <div style="display:flex; gap:8px;">
            <button id="addTask" class="btn btn-primary" style="flex:1">추가</button>
            <button id="clearTask" class="btn" style="flex:1">초기화</button>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button class="btn" id="notifySoon">D-3 알림 테스트</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Files ================== -->
  <section id="files">
    <div class="grid">
      <div class="card" style="grid-column: span 7;">
        <h3>업로드</h3>
        <div class="h-scroll">
          <input type="file" id="fileInput" multiple />
          <button class="btn" id="uploadFile">업로드</button>
          <input class="input" id="fileSearch" placeholder="검색(파일명/댓글)" style="max-width: 220px;" />
          <select id="fileType" class="input" style="max-width: 160px;">
            <option value="ALL">유형: 전체</option>
            <option>이미지</option><option>문서</option><option>영상</option><option>오디오</option><option>기타</option>
          </select>
          <select id="fileSort" class="input" style="max-width: 160px;">
            <option value="recent">정렬: 최신 업로드</option>
            <option value="name">이름</option>
            <option value="type">유형</option>
            <option value="size">용량</option>
            <option value="opened">최근 열람</option>
            <option value="comments">댓글 수</option>
          </select>
          <button class="btn" id="toggleView">보기: 리스트</button>
        </div>
        <div id="fileList" style="margin-top: 12px;"></div>
      </div>
      <div class="card" style="grid-column: span 5;">
        <h3>미리보기</h3>
        <div id="filePreview" class="preview">파일을 선택하세요.</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" id="downloadFile">다운로드</button>
          <button class="btn" id="pinFile">핀 고정/해제</button>
          <button class="btn" id="delFile">삭제</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Progress ================== -->
  <section id="progress">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="h-scroll">
          <select id="pYear" class="input" style="max-width:120px;"></select>
          <select id="pTerm" class="input" style="max-width:120px;"><option value="1">1학기</option><option value="2">2학기</option></select>
          <input class="input" id="pSubject" placeholder="과목 (예: 국어)" style="max-width:160px;" />
          <input class="input" id="pClass" placeholder="반 (예: 1-1)" style="max-width:120px;" />
          <button class="btn" id="pFilter">조회</button>
          <button class="btn" id="pAdd">행 추가</button>
          <button class="btn" id="pCopy">다른 반으로 복사</button>
          <button class="btn" id="pExport">CSV 내보내기</button>
          <label class="btn" for="pImport">CSV 가져오기</label>
          <input id="pImport" type="file" accept=".csv" style="display:none" />
        </div>
        <div class="table-wrap">
          <table class="table responsive" id="pTable" style="margin-top:10px">
            <thead><tr>
              <th>주차</th><th>날짜</th><th>차시</th><th>단원/범위</th><th>목표</th><th>활동/자료</th><th>과제</th><th>메모</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="grid-column: span 12;">
        <h3>주간 반별 격차</h3>
        <div class="chart"><canvas id="chWeeklyGap"></canvas></div>
      </div>
    </div>
  </section>

  <!-- ================== Plans ================== -->
  <section id="plans">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="h-scroll">
          <select id="plYear" class="input" style="max-width:120px;"></select>
          <select id="plTerm" class="input" style="max-width:120px;"><option value="1">1학기</option><option value="2">2학기</option></select>
          <input class="input" id="plSubject" placeholder="과목" style="max-width:160px;" />
          <input class="input" id="plClass" placeholder="반" style="max-width:120px;" />
          <button class="btn" id="plAdd">차시 추가</button>
          <button class="btn" id="plAuto">주차→차시 자동 배분</button>
          <button class="btn" id="plCopy">다른 반으로 복사</button>
          <button class="btn" id="plExport">CSV 내보내기</button>
          <label class="btn" for="plImport">CSV 가져오기</label>
          <input id="plImport" type="file" accept=".csv" style="display:none" />
        </div>
        <div class="table-wrap">
          <table class="table responsive" id="plTable" style="margin-top:10px">
            <thead><tr>
              <th>차시</th><th>주차</th><th>날짜</th><th>목표</th><th>핵심개념</th><th>준비물</th><th>자료링크</th><th>평가방법</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Assessments ================== -->
  <section id="assess">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="h-scroll">
          <input class="input" id="asSubject" placeholder="과목" style="max-width:160px;">
          <input class="input" id="asClass" placeholder="반" style="max-width:120px;">
          <button class="btn" id="asAdd">평가 추가</button>
          <button class="btn" id="asExport">CSV 내보내기</button>
          <label class="btn" for="asImport">CSV 가져오기</label>
          <input id="asImport" type="file" accept=".csv" style="display:none" />
        </div>
        <div class="table-wrap" id="assTable-wrapper">
          <table class="table responsive" id="assTable" style="margin-top:10px">
            <thead>
              <tr>
                <th>제목</th><th>유형</th><th>범위</th><th>날짜</th><th>반</th><th>과목</th><th>미응시</th><th>보충(일시/장)</th><th>메모</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Minimum Achievement ================== -->
  <section id="minachv">
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="h-scroll">
          <input class="input" id="maSubject" placeholder="과목" style="max-width:160px;">
          <input class="input" id="maClass" placeholder="반" style="max-width:120px;">
          <button class="btn" id="maAdd">세션 추가</button>
          <button class="btn" id="maExport">CSV 내보내기</button>
          <label class="btn" for="maImport">CSV 가져오기</label>
          <input id="maImport" type="file" accept=".csv" style="display:none" />
        </div>
        <div class="table-wrap" id="maTable-wrapper">
          <table class="table responsive" id="maTable" style="margin-top:10px">
            <thead><tr>
              <th>모드</th><th>제목</th><th>날짜</th><th>반</th><th>과목</th><th>내용</th><th>대상</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ================== Settings ================== -->
  <section id="settings">
    <div class="grid">
      <div class="card" style="grid-column: span 6;">
        <h3>테마</h3>
        <div style="display:grid; gap:8px;">
          <div><label>포인트 색상(Hue)</label><input type="range" id="hue" min="0" max="360" value="30" oninput="setHue(this.value)"/></div>
          <div>
            <label>프리셋(레이아웃 유지, 색상만 변경)</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" onclick="setPreset('classic')">Classic(네이비)</button>
              <button class="btn" onclick="setPreset('arcade')">Arcade(라일락)</button>
              <button class="btn" onclick="setPreset('soft')">Soft(세이지)</button>
            </div>
          </div>
          <div>
            <label>밝기</label>
            <div style="display:flex; gap:8px;">
              <button class="btn" onclick="toggleDark(false)">밝은 모드</button>
              <button class="btn" onclick="toggleDark(true)">다크 모드</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card" style="grid-column: span 6;">
        <h3>백업/복원</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="exportJSON">JSON 백업</button>
          <label class="btn" for="importJSON">JSON 복원</label>
          <input id="importJSON" type="file" accept="application/json" style="display:none">
          <button class="btn" id="resetAll">초기화</button>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="toast" style="position: fixed; right: 16px; bottom: 16px; display:flex; flex-direction:column; gap:10px; z-index:100;"></div>

<script>
/* ================== Core State Management ================== */
const STORE = "teacher-mvpplus-v1";
let state = loadState();

function loadState() {
  try {
    const raw = localStorage.getItem(STORE);
    if (!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return Object.assign(defaultState(), parsed);
  } catch {
    return defaultState();
  }
}

function saveState() {
  localStorage.setItem(STORE, JSON.stringify(state));
}

function defaultState() {
  const today = new Date().toISOString().slice(0, 10);
  return {
    settings: { preset: "classic", dark: false, hue: 30 },
    events: [{
      id: generateId(),
      title: "개학식",
      date: today,
      memo: "강당",
      classMemos: {},
      createdAt: now()
    }],
    tasks: [{
      id: generateId(),
      title: "가정통신문 배포",
      role: "담임",
      due: addDays(3),
      progress: 10,
      memo: "1학년 전반",
      status: "todo",
      createdAt: now()
    }],
    files: [],
    progress: [],
    plans: [],
    assessments: [],
    assess: [],
    min_achievement: []
  };
}

/* ================== Utility Functions ================== */
function generateId() {
  try {
    if (window.crypto && typeof window.crypto.randomUUID === 'function') {
      return window.crypto.randomUUID();
    }
  } catch (e) {}
  
  const s = () => Math.random().toString(36).slice(2, 10);
  return `id-${Date.now().toString(36)}-${s()}${s()}`;
}

function now() {
  return new Date().toISOString();
}

function addDays(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0, 10);
}

function byId(id) {
  return document.getElementById(id);
}

function formatDate(s) {
  if (!s) return "";
  const d = new Date(s);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function getDDay(due) {
  if (!due) return "";
  const d = new Date(due);
  const t = new Date();
  t.setHours(0, 0, 0, 0);
  const diff = Math.ceil((d - t) / 86400000);
  if (diff > 0) return `D-${diff}`;
  if (diff === 0) return "D-day";
  return `D+${Math.abs(diff)}`;
}

function toast(msg, sub = "") {
  const wrap = byId("toast");
  const el = document.createElement("div");
  el.className = "card";
  el.innerHTML = `<strong>${msg}</strong><div class="small">${sub}</div>`;
  wrap.appendChild(el);
  setTimeout(() => el.remove(), 4500);
}

function getWeekNumber(d) {
  d = new Date(d);
  d.setHours(0, 0, 0, 0);
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const days = Math.floor((d - jan1) / 86400000) + jan1.getDay() + 1;
  return Math.ceil(days / 7);
}

function downloadCSV(filename, rows) {
  const csvContent = rows.map(row => row.map(field => `"${field}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

function importCSV(file, callback) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const csv = e.target.result;
    const rows = csv.split('\n').map(row => {
      const fields = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < row.length; i++) {
        const char = row[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          fields.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      fields.push(current.trim());
      return fields;
    }).filter(row => row.length > 0);
    callback(rows);
  };
  reader.readAsText(file);
}

/* ================== Theme Management ================== */
function applyHue(hue) {
  const h = Number(hue);
  document.documentElement.style.setProperty('--hue', h);
  document.documentElement.style.setProperty('--accent', `hsl(${h}, 45%, 48%)`);
  document.documentElement.style.setProperty('--accent-strong', `hsl(${h}, 55%, 42%)`);
}

function setHue(v) {
  state.settings.hue = Number(v);
  applyHue(state.settings.hue);
  saveState();
}

function toggleDark(d) {
  document.body.setAttribute('data-theme', d ? 'dark' : 'light');
  state.settings.dark = !!d;
  saveState();
}

function setPreset(p) {
  state.settings.preset = p;
  saveState();

  // Layout class switching
  document.body.classList.remove("theme-classic", "theme-arcade", "theme-soft");
  if (p === "classic") document.body.classList.add("theme-classic");
  if (p === "arcade") document.body.classList.add("theme-arcade");
  if (p === "soft") document.body.classList.add("theme-soft");

  // Layout area display switching
  byId("headerTop").style.display = p === "classic" ? "block" : "none";
  byId("headerSide").style.display = p === "soft" ? "block" : "none";
  byId("dock").style.display = p === "arcade" ? "flex" : "none";

  // Preset-specific Hue
  const hue = p === "classic" ? 212 : p === "arcade" ? 265 : 170;
  state.settings.hue = hue;
  applyHue(hue);
  saveState();
}

/* ================== Navigation Management ================== */
function bindNavigation(container) {
  if (!container) return;
  Array.from(container.querySelectorAll("[data-target]")).forEach(btn => {
    btn.addEventListener("click", () => {
      // Hide all sections
      document.querySelectorAll("main section").forEach(s => s.classList.remove("active"));
      // Remove active from all nav buttons
      document.querySelectorAll("[data-target]").forEach(b => b.classList.remove("active"));
      // Show target section
      byId(btn.dataset.target).classList.add("active");
      // Add active to all buttons with same target
      Array.from(document.querySelectorAll("[data-target='" + btn.dataset.target + "']"))
        .forEach(b => b.classList.add("active"));
      
      // Trigger section-specific renders
      switch (btn.dataset.target) {
        case "dash": renderDashboard(); break;
        case "calendar": renderCalendar(); break;
        case "tasks": renderKanban(); break;
        case "files": renderFiles(); break;
        case "progress": renderProgress(); drawWeeklyGap(); break;
        case "plans": renderPlans(); break;
        case "assess": renderAssessments(); break;
        case "minachv": renderMinimumAchievement(); break;
      }
    });
  });
}

/* ================== Dashboard ================== */
function renderDashboard() {
  // Week range calculation
  const today = new Date();
  const start = new Date(today);
  start.setDate(today.getDate() - today.getDay());
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  
  const inWeek = d => {
    const x = new Date(d);
    return x >= start && x <= end;
  };

  // Compose week events
  const weekEvents = state.events.filter(e => inWeek(e.date));
  const weekAssess = (state.assess || []).filter(a => inWeek(a.date) || (a.makeup && inWeek(a.makeup.date)));
  const weekMin = state.min_achievement.filter(m => inWeek(m.date));
  const weekTasks = state.tasks.filter(t => inWeek(t.due));

  byId("dashWeek").innerHTML = [
    ...weekEvents.map(e => `<div class="file-card"><div><strong>행사</strong> ${e.title} <span class="small">(${formatDate(e.date)})</span></div><div class="small">${Object.keys(e.classMemos || {}).length ? '반별 메모 있음' : ''}</div></div>`),
    ...weekAssess.map(a => `<div class="file-card"><div><strong>평가</strong> ${a.title} ${a.type} <span class="small">(${formatDate(a.date)})</span></div><div class="small">${a.makeup ? '보충 ' + a.makeup : ''}</div></div>`),
    ...weekMin.map(m => `<div class="file-card"><div><strong>${m.mode === 'prevention' ? '예방' : '보충'}</strong> ${m.title} <span class="small">(${formatDate(m.date)})</span></div><div class="small">${m.class} ${m.subject || ''}</div></div>`),
    ...weekTasks.map(t => `<div class="file-card"><div><strong>업무</strong> ${t.title}</div><div class="small">마감 ${formatDate(t.due)}</div></div>`)
  ].join("") || '<div class="small">이번 주 일정이 없습니다.</div>';

  // Due soon tasks
  const dueSoon = state.tasks.filter(t => 
    t.status !== "done" && Math.ceil((new Date(t.due) - new Date()) / 86400000) <= 3
  ).sort((a, b) => new Date(a.due) - new Date(b.due));

  byId("dashDue").innerHTML = dueSoon.length ? 
    dueSoon.map(t => `<div class="task"><div style="display:flex; justify-content:space-between;"><strong>${t.title}</strong><span class="small">${formatDate(t.due)} · ${getDDay(t.due)}</span></div><div class="progress"><span style="width:${t.progress}%"></span></div><div class="small">진행률 ${t.progress}% · ${t.role}</div></div>`).join("") : 
    '<div class="small">임박 업무가 없습니다.</div>';

  // Charts
  drawBarChart(byId("chTask").getContext("2d"), ["할 일", "진행", "완료"], [
    state.tasks.filter(x => x.status === "todo").length,
    state.tasks.filter(x => x.status === "doing").length,
    state.tasks.filter(x => x.status === "done").length
  ]);

  // Gap analysis
  const week = getWeekNumber(today);
  const classes = [...new Set(state.progress.filter(p => p.week == week).map(p => p.class))];
  const counts = classes.map(c => 
    state.progress.filter(p => p.week == week && p.class === c)
      .reduce((s, p) => s + (Number(p.period) || 0), 0)
  );
  drawBarChart(byId("chGap").getContext("2d"), 
    classes.length ? classes : ["데이터 없음"], 
    counts.length ? counts : [0]
  );
}

/* ================== Calendar Management ================== */
let currentMonth = new Date();
currentMonth.setDate(1);

function renderCalendar() {
  byId("monthLabel").textContent = `${currentMonth.getFullYear()}년 ${currentMonth.getMonth() + 1}월`;
  
  const grid = byId("calGrid");
  grid.innerHTML = "";
  
  // Day names
  const names = ["일", "월", "화", "수", "목", "금", "토"];
  for (const n of names) {
    const d = document.createElement("div");
    d.className = "day-name";
    d.textContent = n;
    grid.appendChild(d);
  }
  
  // Calendar dates
  const firstDay = new Date(currentMonth);
  const startIdx = firstDay.getDay();
  const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
  
  // Empty cells for padding
  for (let i = 0; i < startIdx; i++) {
    const c = document.createElement("div");
    c.className = "cell";
    grid.appendChild(c);
  }
  
  const filter = byId("calFilter").value;
  
  // Date cells
  for (let date = 1; date <= daysInMonth; date++) {
    const iso = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
    const cell = document.createElement("div");
    cell.className = "cell";
    
    const head = document.createElement("div");
    head.className = "small";
    head.textContent = `${date}`;
    cell.appendChild(head);
    
    // Add events
    const events = state.events.filter(e => e.date === iso && (filter === "ALL" || filter === "행사"));
    events.forEach(e => {
      const el = document.createElement("div");
      el.className = "event";
      el.innerHTML = `<strong>행사</strong> ${e.title}`;
      el.title = e.memo || "";
      el.onclick = () => openEventMemo(e);
      cell.appendChild(el);
    });
    
    // Add assessments
    const assessments = (state.assess || []).filter(a => 
      (a.date === iso || (typeof a.makeup === 'string' && a.makeup.includes(iso))) && 
      (filter === "ALL" || filter === "평가" || filter === "보충")
    );
    assessments.forEach(a => {
      const el = document.createElement("div");
      el.className = "event";
      el.innerHTML = `<strong>${a.date === iso ? '평가' : '보충'}</strong> ${a.title}`;
      cell.appendChild(el);
    });
    
    // Add tasks
    const tasks = state.tasks.filter(t => t.due === iso && (filter === "ALL" || filter === "업무"));
    tasks.forEach(t => {
      const el = document.createElement("div");
      el.className = "event";
      el.innerHTML = `<strong>업무</strong> ${t.title}`;
      cell.appendChild(el);
    });
    
    // Add progress sessions
    const progress = state.progress.filter(p => p.date === iso && (filter === "ALL" || filter === "수업"));
    progress.forEach(p => {
      const el = document.createElement("div");
      el.className = "event";
      el.innerHTML = `<strong>수업</strong> ${p.subject || ''} ${p.class || ''} ${p.period || ''}차시`;
      cell.appendChild(el);
    });
    
    grid.appendChild(cell);
  }
}

function openEventMemo(e) {
  const classMemos = Object.entries(e.classMemos || {}).map(([k, v]) => `${k}: ${v}`).join("\n") || '-';
  alert(`행사: ${e.title}\n날짜: ${formatDate(e.date)}\n공통 메모: ${e.memo || ''}\n\n반별 메모:\n${classMemos}`);
}

/* ================== Event Management ================== */
let classMemoTemp = {};

function setupEventHandlers() {
  // Calendar navigation
  byId("prevM").onclick = () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
  };
  
  byId("nextM").onclick = () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
  };
  
  byId("calFilter").onchange = renderCalendar;
  
  // Event creation
  byId("addClassMemo").onclick = () => {
    const cls = byId("evClass").value.trim();
    const memo = byId("evClassMemo").value.trim();
    if (!cls || !memo) return;
    
    classMemoTemp[cls] = memo;
    byId("evClassMemoList").innerHTML = Object.entries(classMemoTemp)
      .map(([k, v]) => `<div class="small">${k}: ${v}</div>`).join("");
    byId("evClass").value = "";
    byId("evClassMemo").value = "";
  };
  
  byId("addEvent").onclick = () => {
    const title = byId("evTitle").value.trim();
    const date = byId("evDate").value;
    
    if (!title || !date) {
      toast("입력 오류", "행사명/날짜 필수");
      return;
    }
    
    const memo = byId("evMemo").value.trim();
    state.events.push({
      id: generateId(),
      title,
      date,
      memo,
      classMemos: { ...classMemoTemp },
      createdAt: now()
    });
    
    classMemoTemp = {};
    byId("evClassMemoList").innerHTML = "";
    saveState();
    renderCalendar();
    renderDashboard();
    toast("행사 등록", `${title} · ${formatDate(date)}`);
    
    ["evTitle", "evDate", "evMemo"].forEach(id => byId(id).value = "");
  };
  
  byId("clearEvent").onclick = () => {
    ["evTitle", "evDate", "evMemo"].forEach(id => byId(id).value = "");
    classMemoTemp = {};
    byId("evClassMemoList").innerHTML = "";
  };
}

/* ================== Task Management (Kanban) ================== */
function renderKanban() {
  const cols = {
    todo: byId("col-todo"),
    doing: byId("col-doing"),
    done: byId("col-done")
  };
  
  Object.values(cols).forEach(c => c.innerHTML = "");
  
  const tasks = state.tasks.slice().sort((a, b) => new Date(a.due) - new Date(b.due));
  let counts = { todo: 0, doing: 0, done: 0 };
  
  for (const t of tasks) {
    const card = document.createElement("div");
    card.className = "task";
    card.draggable = true;
    
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:8px;">
        <div><strong>${t.title}</strong></div>
        <div class="small">${formatDate(t.due)} · ${getDDay(t.due)}</div>
      </div>
      <div class="small">${t.memo || ""}</div>
      <div class="progress"><span style="width:${t.progress}%"></span></div>
      <div class="small">진행률 ${t.progress}% · ${t.role}</div>
      <div style="display:flex; gap:6px; margin-top:6px;">
        <button class="btn" data-act="edit">편집</button>
        <button class="btn" data-act="del">삭제</button>
      </div>
    `;
    
    // Event handlers
    card.querySelector('[data-act="del"]').onclick = () => {
      if (confirm("삭제할까요?")) {
        state.tasks = state.tasks.filter(x => x.id !== t.id);
        saveState();
        renderKanban();
        renderDashboard();
      }
    };
    
    card.querySelector('[data-act="edit"]').onclick = () => {
      const np = prompt("새 진행률(0-100)", t.progress);
      if (np === null) return;
      const v = Math.max(0, Math.min(100, Number(np) || 0));
      t.progress = v;
      t.status = v >= 100 ? "done" : v > 0 ? "doing" : "todo";
      saveState();
      renderKanban();
      renderDashboard();
    };
    
    // Drag and drop
    card.addEventListener("dragstart", e => e.dataTransfer.setData("text/plain", t.id));
    
    cols[t.status].appendChild(card);
    counts[t.status]++;
  }
  
  // Update counters
  byId("cntTodo").textContent = `${counts.todo}건`;
  byId("cntDoing").textContent = `${counts.doing}건`;
  byId("cntDone").textContent = `${counts.done}건`;
  
  // Setup drop zones
  document.querySelectorAll(".column").forEach(col => {
    col.ondragover = e => e.preventDefault();
    col.ondrop = e => {
      e.preventDefault();
      const id = e.dataTransfer.getData("text/plain");
      const t = state.tasks.find(x => x.id === id);
      if (t) {
        t.status = col.dataset.col;
        if (t.status === "done") t.progress = 100;
        else if (t.status === "doing" && t.progress === 0) t.progress = 10;
        saveState();
        renderKanban();
        renderDashboard();
      }
    };
  });
}

function setupTaskHandlers() {
  byId("addTask").onclick = () => {
    const title = byId("taskTitle").value.trim();
    const role = byId("taskRole").value;
    const due = byId("taskDue").value;
    const progress = Number(byId("taskProg").value) || 0;
    const memo = byId("taskMemo").value.trim();
    
    if (!title || !due) {
      toast("입력 오류", "업무명/마감일");
      return;
    }
    
    const status = progress >= 100 ? "done" : progress > 0 ? "doing" : "todo";
    state.tasks.push({
      id: generateId(),
      title,
      role,
      due,
      progress,
      memo,
      status,
      createdAt: now()
    });
    
    saveState();
    renderKanban();
    renderDashboard();
    
    ["taskTitle", "taskDue", "taskMemo"].forEach(id => byId(id).value = "");
    byId("taskProg").value = 0;
    byId("progVal").innerText = "0%";
  };
  
  byId("clearTask").onclick = () => {
    ["taskTitle", "taskDue", "taskMemo"].forEach(id => byId(id).value = "");
    byId("taskProg").value = 0;
    byId("progVal").innerText = "0%";
  };
  
  byId("notifySoon").onclick = () => {
    const soon = state.tasks.filter(t => 
      Math.ceil((new Date(t.due) - new Date()) / 86400000) <= 3 && t.status !== "done"
    );
    if (!soon.length) {
      toast("알림", "3일 내 마감 없음");
    } else {
      soon.forEach(t => toast("임박 업무", `${t.title} · ${formatDate(t.due)} (${getDDay(t.due)})`));
    }
  };
}

/* ================== File Management ================== */
let fileView = "list";
let selectedFileId = null;

function getFileType(name) {
  const ext = (name.split(".").pop() || "").toLowerCase();
  if (["jpg", "jpeg", "png", "gif", "svg", "webp"].includes(ext)) return "이미지";
  if (["pdf", "txt", "md", "csv"].includes(ext)) return "문서";
  if (["mp4", "webm", "mov", "m4v"].includes(ext)) return "영상";
  if (["mp3", "wav", "ogg", "m4a"].includes(ext)) return "오디오";
  return "기타";
}

function renderFiles() {
  const wrap = byId("fileList");
  const query = byId("fileSearch").value.trim().toLowerCase();
  const filterType = byId("fileType").value;
  const sort = byId("fileSort").value;
  
  let files = state.files.slice();
  
  // Filter
  files = files.filter(f => 
    (filterType === "ALL" || f.type === filterType) && 
    (f.name.toLowerCase().includes(query) || 
     (f.comments || []).some(c => c.toLowerCase().includes(query)))
  );
  
  // Sort
  files.sort((a, b) => {
    if (a.pin !== b.pin) return a.pin ? -1 : 1;
    switch (sort) {
      case "recent": return new Date(b.createdAt) - new Date(a.createdAt);
      case "name": return a.name.localeCompare(b.name, "ko");
      case "type": return a.type.localeCompare(b.type, "ko");
      case "size": return (b.size || 0) - (a.size || 0);
      case "opened": return new Date(b.lastOpen || 0) - new Date(a.lastOpen || 0);
      case "comments": return (b.comments?.length || 0) - (a.comments?.length || 0);
      default: return 0;
    }
  });
  
  // Render
  wrap.innerHTML = "";
  if (!files.length) {
    wrap.innerHTML = '<div class="small">파일이 없습니다.</div>';
    return;
  }
  
  const list = document.createElement("div");
  list.style.display = "grid";
  list.style.gap = "8px";
  list.style.gridTemplateColumns = fileView === "grid" ? 
    "repeat(auto-fill, minmax(220px,1fr))" : "1fr";
  
  files.forEach(f => {
    const row = document.createElement("div");
    row.className = "file-card";
    row.tabIndex = 0;
    
    row.innerHTML = `
      <div style="flex:1 1 auto;">
        <div><strong>${f.name}</strong> ${f.pin ? '<span class="pin">★</span>' : ''}</div>
        <div class="file-meta">${f.type} · ${f.size || 0}B · 업로드 ${formatDate(f.createdAt)}</div>
        <div id="cmt-${f.id}">${(f.comments || []).slice(-2).map(c => `<div class="small">• ${c}</div>`).join("")}</div>
        <div style="display:flex; gap:6px; margin-top:6px;">
          <input class="input" id="inp-${f.id}" placeholder="댓글 추가..." />
          <button class="btn" data-add="${f.id}">추가</button>
        </div>
      </div>
      <div><button class="btn" data-open="${f.id}">열기</button></div>
    `;
    
    row.querySelector(`[data-add="${f.id}"]`).onclick = () => {
      const val = byId(`inp-${f.id}`).value.trim();
      if (!val) return;
      f.comments = f.comments || [];
      f.comments.push(val);
      saveState();
      byId(`cmt-${f.id}`).insertAdjacentHTML("beforeend", `<div class="small">• ${val}</div>`);
      byId(`inp-${f.id}`).value = "";
    };
    
    row.querySelector(`[data-open="${f.id}"]`).onclick = () => openFile(f.id);
    row.addEventListener("keydown", e => {
      if (e.key === "Enter") openFile(f.id);
    });
    
    list.appendChild(row);
  });
  
  wrap.appendChild(list);
}

function openFile(id) {
  selectedFileId = id;
  const f = state.files.find(x => x.id === id);
  if (!f) return;
  
  f.lastOpen = now();
  saveState();
  
  const prev = byId("filePreview");
  
  if (f.type === "이미지") {
    prev.innerHTML = `<img src="${f.data}" alt="${f.name}" style="max-width:100%; height:auto; border-radius:12px;" />`;
  } else if (f.type === "문서") {
    if (f.name.toLowerCase().endsWith(".pdf")) {
      prev.innerHTML = `<embed src="${f.data}" type="application/pdf" style="width:100%; height:300px; border:0; border-radius:8px;">`;
    } else {
      fetch(f.data).then(r => r.text()).then(t => {
        const lines = t.split(/\r?\n/).slice(0, 20).join("\n")
          .replace(/[&<>]/g, s => ({"&": "&amp;", "<": "&lt;", ">": "&gt;"}[s]));
        prev.innerHTML = `<pre style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">${lines}</pre>`;
      }).catch(() => prev.textContent = "미리보기를 불러올 수 없습니다.");
    }
  } else if (f.type === "영상") {
    prev.innerHTML = `<video controls src="${f.data}" style="max-width:100%; border-radius:8px;"></video>`;
  } else if (f.type === "오디오") {
    prev.innerHTML = `<audio controls src="${f.data}" style="width:100%"></audio>`;
  } else {
    prev.innerHTML = `<div class="small">미리보기를 지원하지 않는 유형입니다. 다운로드로 열어주세요.</div>`;
  }
}

function setupFileHandlers() {
  byId("toggleView").onclick = () => {
    fileView = fileView === "list" ? "grid" : "list";
    byId("toggleView").textContent = `보기: ${fileView === "list" ? "리스트" : "그리드"}`;
    renderFiles();
  };
  
  byId("uploadFile").onclick = () => {
    const input = byId("fileInput");
    if (!input.files?.length) {
      toast("업로드 실패", "파일 선택");
      return;
    }
    
    Array.from(input.files).forEach(f => {
      const id = generateId();
      const reader = new FileReader();
      reader.onload = () => {
        state.files.push({
          id,
          name: f.name,
          size: f.size,
          type: getFileType(f.name),
          data: reader.result,
          createdAt: now(),
          lastOpen: null,
          pin: false,
          comments: [],
          link: null
        });
        saveState();
        renderFiles();
        input.value = "";
        toast("업로드", `${f.name} (${f.size}B)`);
      };
      reader.readAsDataURL(f);
    });
  };
  
  byId("downloadFile").onclick = () => {
    const f = state.files.find(x => x.id === selectedFileId);
    if (!f) {
      toast("선택 없음");
      return;
    }
    const a = document.createElement("a");
    a.href = f.data;
    a.download = f.name;
    a.click();
  };
  
  byId("pinFile").onclick = () => {
    const f = state.files.find(x => x.id === selectedFileId);
    if (!f) return;
    f.pin = !f.pin;
    saveState();
    renderFiles();
  };
  
  byId("delFile").onclick = () => {
    if (!selectedFileId) return;
    if (confirm("삭제할까요?")) {
      state.files = state.files.filter(x => x.id !== selectedFileId);
      saveState();
      renderFiles();
      byId("filePreview").innerHTML = "파일을 선택하세요.";
      selectedFileId = null;
    }
  };
  
  byId("fileSearch").oninput = renderFiles;
  byId("fileType").onchange = renderFiles;
  byId("fileSort").onchange = renderFiles;
}

/* ================== Progress Management ================== */
function setupYearOptions(sel) {
  sel.innerHTML = "";
  const y = new Date().getFullYear();
  for (let i = -1; i <= 1; i++) {
    const opt = document.createElement("option");
    opt.value = y + i;
    opt.textContent = y + i;
    sel.appendChild(opt);
  }
  sel.value = y;
}

function renderProgress() {
  const tbody = byId("pTable").querySelector("tbody");
  tbody.innerHTML = "";
  
  const y = Number(byId("pYear").value);
  const t = Number(byId("pTerm").value);
  const s = byId("pSubject").value.trim();
  const c = byId("pClass").value.trim();
  
  const rows = state.progress.filter(p => 
    (!y || p.year == y) && 
    (!t || p.term == t) && 
    (!s || p.subject == s) && 
    (!c || p.class == c)
  ).sort((a, b) => new Date(a.date) - new Date(b.date) || (a.period - b.period));
  
  rows.forEach(p => addProgressRow(p, true));
  hydrateResponsiveTables();
}

function addProgressRow(p, append = false) {
  if (!p.id) {
    p.id = generateId();
    state.progress.push(p);
    saveState();
  }
  
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td data-label="주차"><input class="input" value="${p.week || ''}" style="max-width:70px"></td>
    <td data-label="날짜"><input class="input" type="date" value="${p.date || ''}" style="max-width:150px"></td>
    <td data-label="차시"><input class="input" value="${p.period || ''}" style="max-width:70px"></td>
    <td data-label="단원/범위"><input class="input" value="${p.unit || ''}"></td>
    <td data-label="목표"><input class="input" value="${p.goal || ''}"></td>
    <td data-label="활동/자료"><input class="input" value="${p.activities || ''}"></td>
    <td data-label="과제"><input class="input" value="${p.homework || ''}"></td>
    <td data-label="메모"><input class="input" value="${p.note || ''}"></td>
    <td data-label=""><button class="btn">삭제</button></td>
  `;
  
  const [w, d, pr, unit, goal, act, hw, note, del] = tr.querySelectorAll("td > *");
  
  const sync = () => {
    p.week = Number(w.value) || 0;
    p.date = d.value;
    p.period = Number(pr.value) || 0;
    p.unit = unit.value;
    p.goal = goal.value;
    p.activities = act.value;
    p.homework = hw.value;
    p.note = note.value;
    saveState();
    drawWeeklyGap();
    renderCalendar();
    renderDashboard();
  };
  
  [w, d, pr, unit, goal, act, hw, note].forEach(el => 
    el.addEventListener("change", sync)
  );
  
  del.onclick = () => {
    if (confirm("삭제할까요?")) {
      state.progress = state.progress.filter(x => x.id !== p.id);
      saveState();
      renderProgress();
      drawWeeklyGap();
      renderCalendar();
      renderDashboard();
    }
  };
  
  byId("pTable").querySelector("tbody").appendChild(tr);
}

function drawWeeklyGap() {
  const ctx = byId("chWeeklyGap").getContext("2d");
  const week = getWeekNumber(new Date());
  const classes = [...new Set(state.progress.filter(p => p.week == week).map(p => p.class))];
  const counts = classes.map(c => 
    state.progress.filter(p => p.week == week && p.class === c)
      .reduce((s, p) => s + (Number(p.period) || 0), 0)
  );
  drawBarChart(ctx, classes.length ? classes : ["데이터 없음"], counts.length ? counts : [0]);
}

function setupProgressHandlers() {
  setupYearOptions(byId("pYear"));
  
  byId("pFilter").onclick = renderProgress;
  
  byId("pAdd").onclick = () => addProgressRow({
    year: Number(byId("pYear").value),
    term: Number(byId("pTerm").value),
    subject: byId("pSubject").value.trim(),
    class: byId("pClass").value.trim(),
    week: getWeekNumber(new Date()),
    date: new Date().toISOString().slice(0, 10),
    period: 1,
    unit: "",
    goal: "",
    activities: "",
    homework: "",
    note: ""
  });
  
  byId("pCopy").onclick = () => {
    const src = state.progress.filter(p => 
      p.year == byId("pYear").value && 
      p.term == byId("pTerm").value && 
      p.subject == byId("pSubject").value.trim() && 
      p.class == byId("pClass").value.trim()
    );
    const to = prompt("복사 대상 반(쉼표로 여러 개)");
    if (!to) return;
    
    to.split(",").map(s => s.trim()).filter(Boolean).forEach(cls => {
      src.forEach(p => state.progress.push({...p, id: generateId(), class: cls}));
    });
    saveState();
    toast("복사 완료", "선택 반으로 복사되었습니다.");
  };
  
  byId("pExport").onclick = () => {
    const rows = [["year", "term", "subject", "class", "week", "date", "period", "unit", "goal", "activities", "homework", "note"]]
      .concat(state.progress.map(p => [p.year, p.term, p.subject, p.class, p.week, p.date, p.period, p.unit, p.goal, p.activities, p.homework, p.note]));
    downloadCSV("progress.csv", rows);
  };
  
  byId("pImport").onchange = e => importCSV(e.target.files?.[0], rows => {
    rows.slice(1).forEach(r => {
      if (!r.length) return;
      const [year, term, subject, cls, week, date, period, unit, goal, activities, homework, note] = r;
      state.progress.push({
        id: generateId(),
        year: Number(year),
        term: Number(term),
        subject,
        class: cls,
        week: Number(week),
        date,
        period: Number(period),
        unit,
        goal,
        activities,
        homework,
        note
      });
    });
    saveState();
    renderProgress();
    toast("가져오기 완료", "진도표가 반영되었습니다.");
  });
}

/* ================== Plans Management ================== */
function renderPlans() {
  const tbody = byId("plTable").querySelector("tbody");
  tbody.innerHTML = "";
  
  const y = Number(byId("plYear").value);
  const t = Number(byId("plTerm").value);
  const s = byId("plSubject").value.trim();
  const c = byId("plClass").value.trim();
  
  const rows = state.plans.filter(p => 
    (!y || p.year == y) && 
    (!t || p.term == t) && 
    (!s || p.subject == s) && 
    (!c || p.class == c)
  ).sort((a, b) => (a.period - b.period) || new Date(a.date) - new Date(b.date));
  
  rows.forEach(p => addPlanRow(p, true));
  hydrateResponsiveTables();
}

function addPlanRow(p, append = false) {
  if (!p.id) {
    p.id = generateId();
    state.plans.push(p);
    saveState();
  }
  
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td data-label="차시"><input class="input" value="${p.period || ''}" style="max-width:70px"></td>
    <td data-label="주차"><input class="input" value="${p.week || ''}" style="max-width:70px"></td>
    <td data-label="날짜"><input class="input" type="date" value="${p.date || ''}" style="max-width:150px"></td>
    <td data-label="목표"><input class="input" value="${p.goal || ''}"></td>
    <td data-label="핵심개념"><input class="input" value="${p.keyConcept || ''}"></td>
    <td data-label="준비물"><input class="input" value="${p.materials || ''}"></td>
    <td data-label="자료링크"><input class="input" value="${p.link || ''}"></td>
    <td data-label="평가방법"><input class="input" value="${p.assessment || ''}"></td>
    <td data-label=""><button class="btn">삭제</button></td>
  `;
  
  const [period, week, date, goal, key, mat, link, ass, del] = tr.querySelectorAll("td > *");
  
  const sync = () => {
    p.period = Number(period.value) || 0;
    p.week = Number(week.value) || 0;
    p.date = date.value;
    p.goal = goal.value;
    p.keyConcept = key.value;
    p.materials = mat.value;
    p.link = link.value;
    p.assessment = ass.value;
    saveState();
  };
  
  [period, week, date, goal, key, mat, link, ass].forEach(el => 
    el.addEventListener("change", sync)
  );
  
  del.onclick = () => {
    if (confirm("삭제할까요?")) {
      state.plans = state.plans.filter(x => x.id !== p.id);
      saveState();
      renderPlans();
    }
  };
  
  byId("plTable").querySelector("tbody").appendChild(tr);
}

function setupPlansHandlers() {
  setupYearOptions(byId("plYear"));
  
  byId("plAdd").onclick = () => addPlanRow({
    year: Number(byId("plYear").value),
    term: Number(byId("plTerm").value),
    subject: byId("plSubject").value.trim(),
    class: byId("plClass").value.trim(),
    period: 1,
    week: getWeekNumber(new Date()),
    date: new Date().toISOString().slice(0, 10),
    goal: "",
    keyConcept: "",
    materials: "",
    link: "",
    assessment: ""
  });
  
  byId("plAuto").onclick = () => {
    const startW = Number(prompt("시작 주차", getWeekNumber(new Date())) || 0);
    const count = Number(prompt("생성할 차시 수", 4) || 0);
    for (let i = 0; i < count; i++) {
      addPlanRow({
        year: Number(byId("plYear").value),
        term: Number(byId("plTerm").value),
        subject: byId("plSubject").value.trim(),
        class: byId("plClass").value.trim(),
        period: i + 1,
        week: startW,
        date: "",
        goal: "",
        keyConcept: "",
        materials: "",
        link: "",
        assessment: ""
      });
    }
    toast("자동 배분", "차시 뼈대가 생성되었습니다.");
  };
  
  byId("plCopy").onclick = () => {
    const src = state.plans.filter(p => 
      p.year == byId("plYear").value && 
      p.term == byId("plTerm").value && 
      p.subject == byId("plSubject").value.trim() && 
      p.class == byId("plClass").value.trim()
    );
    const to = prompt("복사 대상 반(쉼표로 여러 개)");
    if (!to) return;
    
    to.split(",").map(s => s.trim()).filter(Boolean).forEach(cls => {
      src.forEach(p => state.plans.push({...p, id: generateId(), class: cls}));
    });
    saveState();
    toast("복사 완료", "계획이 복사되었습니다.");
  };
  
  byId("plExport").onclick = () => {
    const rows = [["year", "term", "subject", "class", "period", "week", "date", "goal", "keyConcept", "materials", "link", "assessment"]]
      .concat(state.plans.map(p => [p.year, p.term, p.subject, p.class, p.period, p.week, p.date, p.goal, p.keyConcept, p.materials, p.link, p.assessment]));
    downloadCSV("plans.csv", rows);
  };
  
  byId("plImport").onchange = e => importCSV(e.target.files?.[0], rows => {
    rows.slice(1).forEach(r => {
      if (!r.length) return;
      const [year, term, subject, cls, period, week, date, goal, keyConcept, materials, link, assessment] = r;
      state.plans.push({
        id: generateId(),
        year: Number(year),
        term: Number(term),
        subject,
        class: cls,
        period: Number(period),
        week: Number(week),
        date,
        goal,
        keyConcept,
        materials,
        link,
        assessment
      });
    });
    saveState();
    renderPlans();
    toast("가져오기 완료", "계획이 반영되었습니다.");
  });
}

/* ================== Assessment Management ================== */
function renderAssessments() {
  const tbody = byId("assTable").querySelector("tbody");
  tbody.innerHTML = "";
  
  (state.assess || []).forEach(a => addAssessmentRow(a));
  hydrateResponsiveTables();
}

function addAssessmentRow(a) {
  if (!a.id) {
    a.id = generateId();
    (state.assess ||= []).push(a);
    saveState();
  }
  
  // Normalize type
  const normType = v =>
    v === "단원" || v === "단원평가" ? "unit" :
    v === "수행" || v === "수행평가" ? "performance" :
    (v === "unit" || v === "performance" ? v : "unit");
  a.type = normType(a.type);
  
  // Handle makeup field
  const makeupVal = (typeof a.makeup === "string") ? a.makeup : 
    (a.makeup ? `${a.makeup.date || ""} ${a.makeup.place || ""}`.trim() : "");
  
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td data-label="제목"><input class="input" data-field="title" value="${a.title || ''}"></td>
    <td data-label="유형">
      <select data-field="type" class="input">
        <option value="unit">단원평가</option>
        <option value="performance">수행평가</option>
      </select>
    </td>
    <td data-label="범위"><input class="input" data-field="scope" value="${a.scope || ''}"></td>
    <td data-label="날짜"><input class="input" data-field="date" type="date" value="${a.date || ''}"></td>
    <td data-label="반"><input class="input" data-field="class" value="${a.class || ''}"></td>
    <td data-label="과목"><input class="input" data-field="subject" value="${a.subject || ''}"></td>
    <td data-label="미응시"><input class="input" data-field="absent" value="${a.absent || ''}" placeholder="홍길동,김…"></td>
    <td data-label="보충(일시/장)"><input class="input" data-field="makeup" value="${makeupVal}" placeholder="연도-월-일 / 장소"></td>
    <td data-label="메모"><input class="input" data-field="memo" value="${a.memo || ''}"></td>
    <td data-label=""><button class="btn" data-field="del">삭제</button></td>
  `;
  
  const typeSelect = tr.querySelector('select[data-field="type"]');
  if (typeSelect) typeSelect.value = a.type;
  
  const sync = () => {
    const title = tr.querySelector('input[data-field="title"]');
    const type = tr.querySelector('select[data-field="type"]');
    const scope = tr.querySelector('input[data-field="scope"]');
    const date = tr.querySelector('input[data-field="date"]');
    const cls = tr.querySelector('input[data-field="class"]');
    const sub = tr.querySelector('input[data-field="subject"]');
    const absent = tr.querySelector('input[data-field="absent"]');
    const makeup = tr.querySelector('input[data-field="makeup"]');
    const memo = tr.querySelector('input[data-field="memo"]');
    
    if (title) a.title = title.value;
    if (type) a.type = type.value;
    if (scope) a.scope = scope.value;
    if (date) a.date = date.value;
    if (cls) a.class = cls.value;
    if (sub) a.subject = sub.value;
    if (absent) a.absent = absent.value;
    if (makeup) a.makeup = makeup.value;
    if (memo) a.memo = memo.value;
    
    saveState();
    renderCalendar();
    renderDashboard();
  };
  
  tr.querySelectorAll('input, select').forEach(el => 
    el.addEventListener("change", sync)
  );
  
  const delBtn = tr.querySelector('[data-field="del"]');
  if (delBtn) {
    delBtn.onclick = () => {
      if (confirm("삭제할까요?")) {
        state.assess = (state.assess || []).filter(x => x.id !== a.id);
        saveState();
        renderAssessments();
        renderCalendar();
        renderDashboard();
      }
    };
  }
  
  byId("assTable").querySelector("tbody").appendChild(tr);
}

function setupAssessmentHandlers() {
  byId("asAdd").onclick = () => addAssessmentRow({
    title: "단원평가",
    type: "unit",
    scope: "",
    date: new Date().toISOString().slice(0, 10),
    class: byId("asClass").value.trim(),
    subject: byId("asSubject").value.trim(),
    absent: "",
    makeup: "",
    memo: ""
  });
  
  byId("asExport").onclick = () => {
    const rows = [["subject", "class", "type", "title", "scope", "date", "absent", "makeup", "memo"]]
      .concat((state.assess || []).map(a => [
        a.subject || "", a.class || "", a.type || "", a.title || "", a.scope || "", 
        a.date || "", a.absent || "", a.makeup || "", a.memo || ""
      ]));
    downloadCSV("assessments.csv", rows);
  };
  
  byId("asImport").onchange = e => importCSV(e.target.files?.[0], rows => {
    rows.slice(1).forEach(r => {
      if (!r.length) return;
      const [subject, cls, type, title, scope, date, absent, makeup, memo] = r;
      (state.assess ||= []).push({
        id: generateId(),
        subject,
        class: cls,
        type,
        title,
        scope,
        date,
        absent,
        makeup,
        memo
      });
    });
    saveState();
    renderAssessments();
    toast("가져오기 완료", "평가가 반영되었습니다.");
  });
}

/* ================== Minimum Achievement Management ================== */
function renderMinimumAchievement() {
  const tbody = byId("maTable").querySelector("tbody");
  tbody.innerHTML = "";
  
  const s = byId("maSubject") ? byId("maSubject").value.trim() : "";
  const c = byId("maClass") ? byId("maClass").value.trim() : "";
  
  (state.min_achievement || [])
    .filter(m => (!s || m.subject === s) && (!c || m.class === c))
    .sort((a, b) => new Date(a.date || "2100-01-01") - new Date(b.date || "2100-01-01"))
    .forEach(m => addMinAchievementRow(m, true));
  
  hydrateResponsiveTables();
}

function addMinAchievementRow(m, append = false) {
  if (!m.id) {
    m.id = generateId();
    (state.min_achievement ||= []).push(m);
    saveState();
  }
  
  // Normalize mode
  if (m.mode === "예방") m.mode = "prevention";
  if (m.mode === "보충") m.mode = "remediation";
  if (!m.mode) m.mode = "prevention";
  
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td data-label="모드">
      <select data-field="mode" class="input">
        <option value="prevention">예방</option>
        <option value="remediation">보충</option>
      </select>
    </td>
    <td data-label="제목"><input class="input" data-field="title" value="${m.title || ''}"></td>
    <td data-label="날짜"><input class="input" data-field="date" type="date" value="${m.date || ''}"></td>
    <td data-label="반"><input class="input" data-field="class" value="${m.class || ''}"></td>
    <td data-label="과목"><input class="input" data-field="subject" value="${m.subject || ''}"></td>
    <td data-label="내용"><input class="input" data-field="content" value="${m.content || ''}"></td>
    <td data-label="대상"><input class="input" data-field="participants" value="${m.participants || ''}" placeholder="전원/일부/N명"></td>
    <td data-label=""><button class="btn" data-field="del">삭제</button></td>
  `;
  
  const modeSelect = tr.querySelector('select[data-field="mode"]');
  if (modeSelect) modeSelect.value = m.mode;
  
  const sync = () => {
    const mode = tr.querySelector('select[data-field="mode"]');
    const title = tr.querySelector('input[data-field="title"]');
    const date = tr.querySelector('input[data-field="date"]');
    const cls = tr.querySelector('input[data-field="class"]');
    const sub = tr.querySelector('input[data-field="subject"]');
    const content = tr.querySelector('input[data-field="content"]');
    const part = tr.querySelector('input[data-field="participants"]');
    
    if (mode) m.mode = mode.value;
    if (title) m.title = title.value;
    if (date) m.date = date.value;
    if (cls) m.class = cls.value;
    if (sub) m.subject = sub.value;
    if (content) m.content = content.value;
    if (part) m.participants = part.value;
    
    // Clean up legacy fields
    delete m.time;
    delete m.followup;
    delete m.result;
    
    saveState();
    renderCalendar();
    renderDashboard();
  };
  
  tr.querySelectorAll('input, select').forEach(el => 
    el.addEventListener("change", sync)
  );
  
  const delBtn = tr.querySelector('[data-field="del"]');
  if (delBtn) {
    delBtn.onclick = () => {
      if (confirm("삭제할까요?")) {
        state.min_achievement = (state.min_achievement || []).filter(x => x.id !== m.id);
        saveState();
        renderMinimumAchievement();
        renderCalendar();
        renderDashboard();
      }
    };
  }
  
  byId("maTable").querySelector("tbody").appendChild(tr);
}

function setupMinAchievementHandlers() {
  byId("maAdd").onclick = () => addMinAchievementRow({
    mode: "prevention",
    title: "보강 학습",
    date: new Date().toISOString().slice(0, 10),
    class: byId("maClass").value.trim(),
    subject: byId("maSubject").value.trim(),
    content: "",
    participants: ""
  });
  
  byId("maExport").onclick = () => {
    const rows = [["subject", "class", "mode", "title", "date", "content", "participants"]]
      .concat((state.min_achievement || []).map(m => [
        m.subject || "", m.class || "", m.mode || "", m.title || "", 
        m.date || "", m.content || "", m.participants || ""
      ]));
    downloadCSV("min_achievement.csv", rows);
  };
  
  byId("maImport").onchange = e => importCSV(e.target.files?.[0], rows => {
    rows.slice(1).forEach(r => {
      if (!r.length) return;
      const [subject, cls, mode, title, date, content, participants] = r;
      (state.min_achievement ||= []).push({
        id: generateId(),
        subject,
        class: cls,
        mode,
        title,
        date,
        content,
        participants
      });
    });
    saveState();
    renderMinimumAchievement();
    toast("가져오기 완료", "보장지도 데이터 반영");
  });
}

/* ================== Chart Drawing ================== */
function drawBarChart(ctx, labels, data) {
  const w = ctx.canvas.width = ctx.canvas.clientWidth * devicePixelRatio;
  const h = ctx.canvas.height = ctx.canvas.clientHeight * devicePixelRatio;
  ctx.clearRect(0, 0, w, h);
  
  const padding = 40 * devicePixelRatio;
  const maxVal = Math.max(1, ...data);
  const barWidth = (w - padding * 2) / data.length * 0.6;
  const gap = (w - padding * 2) / data.length * 0.4;
  
  const style = getComputedStyle(document.body);
  ctx.strokeStyle = style.getPropertyValue('--border');
  ctx.fillStyle = style.getPropertyValue('--text');
  ctx.lineWidth = 1 * devicePixelRatio;
  
  // Draw axes
  ctx.beginPath();
  ctx.moveTo(padding, h - padding);
  ctx.lineTo(w - padding, h - padding);
  ctx.moveTo(padding, h - padding);
  ctx.lineTo(padding, padding);
  ctx.stroke();
  
  const accent = style.getPropertyValue('--accent').trim();
  
  // Draw bars
  for (let i = 0; i < data.length; i++) {
    const x = padding + i * (barWidth + gap);
    const y = (h - padding) - (data[i] / maxVal) * (h - padding * 2);
    
    // Bar
    ctx.fillStyle = accent;
    ctx.fillRect(x, y, barWidth, (h - padding) - y);
    
    // Value label
    ctx.fillStyle = style.getPropertyValue('--text');
    ctx.font = `${12 * devicePixelRatio}px system-ui, sans-serif`;
    ctx.fillText(String(data[i]), x, y - 6 * devicePixelRatio);
    
    // X-axis label
    ctx.fillText(labels[i] || "", x, h - padding + 14 * devicePixelRatio);
  }
}

/* ================== Settings Management ================== */
function setupSettingsHandlers() {
  byId("exportJSON").onclick = () => {
    const a = document.createElement("a");
    a.href = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state, null, 2));
    a.download = "backup.json";
    a.click();
  };
  
  byId("importJSON").onchange = async e => {
    const f = e.target.files?.[0];
    if (!f) return;
    const txt = await f.text();
    try {
      const next = JSON.parse(txt);
      state = Object.assign(defaultState(), next);
      saveState();
      initializeApp();
      toast("복원 완료");
    } catch (err) {
      toast("복원 실패", String(err));
    }
  };
  
  byId("resetAll").onclick = () => {
    if (confirm("모든 데이터를 초기화할까요?")) {
      state = defaultState();
      saveState();
      initializeApp();
      toast("초기화 완료");
    }
  };
}

/* ================== Mobile Responsive Tables ================== */
window.hydrateResponsiveTables = function() {
  document.querySelectorAll('table.responsive').forEach(table => {
    const ths = table.tHead ? Array.from(table.tHead.querySelectorAll('th')) : [];
    if (!ths.length) return;
    
    const headers = ths.map(th => (th.textContent || '').trim());
    
    table.querySelectorAll('tbody tr').forEach(tr => {
      Array.from(tr.children).forEach((td, i) => {
        if (td.nodeName !== 'TD') return;
        const label = headers[i] || '';
        const needsLabel = !td.hasAttribute('data-label') || !td.getAttribute('data-label');
        if (needsLabel) td.setAttribute('data-label', label);
      });
    });
    
    // Ensure table wrapper
    if (!table.parentElement || !table.parentElement.classList.contains('table-wrap')) {
      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';
      table.replaceWith(wrap);
      wrap.appendChild(table);
    }
  });
};

/* ================== Mobile Tabbar ================== */
function mountMobileTabbar() {
  if (document.querySelector('.tabbar')) return;
  
  const tabs = [
    { id: 'dash', label: '대시보드', emoji: '🏠' },
    { id: 'calendar', label: '일정', emoji: '📅' },
    { id: 'tasks', label: '업무', emoji: '🗂️' },
    { id: 'files', label: '자료실', emoji: '📁' },
    { id: 'progress', label: '진도', emoji: '📘' },
    { id: 'plans', label: '계획', emoji: '📝' },
    { id: 'assess', label: '평가', emoji: '✅' },
    { id: 'minachv', label: '보장지도', emoji: '🌱' },
    { id: 'settings', label: '설정', emoji: '⚙️' },
  ];
  
  const bar = document.createElement('nav');
  bar.className = 'tabbar safe-bottom';
  bar.innerHTML = '<ul>' + tabs.map(t =>
    `<li><button class="navlink" data-target="${t.id}" aria-label="${t.label}">
       <span>${t.emoji}</span><small>${t.label}</small>
     </button></li>`
  ).join('') + '</ul>';
  
  document.body.appendChild(bar);
  bindNavigation(bar);
}

/* ================== App Initialization ================== */
function initializeApp() {
  // Apply saved settings
  setPreset(state.settings.preset || "classic");
  toggleDark(!!state.settings.dark);
  applyHue(state.settings.hue ?? 30);
  
  // Setup all event handlers
  bindNavigation(byId("navTop"));
  bindNavigation(byId("navSide"));
  bindNavigation(byId("dock"));
  
  setupEventHandlers();
  setupTaskHandlers();
  setupFileHandlers();
  setupProgressHandlers();
  setupPlansHandlers();
  setupAssessmentHandlers();
  setupMinAchievementHandlers();
  setupSettingsHandlers();
  
  // Initial renders
  renderDashboard();
  renderCalendar();
  renderKanban();
  renderFiles();
  renderProgress();
  renderPlans();
  renderAssessments();
  renderMinimumAchievement();
  
  // Set default active section
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  byId("dash").classList.add("active");
  document.querySelectorAll("[data-target]").forEach(b => b.classList.remove("active"));
  document.querySelectorAll("[data-target='dash']").forEach(b => b.classList.add("active"));
  
  // Setup mobile responsive tables
  hydrateResponsiveTables();
  
  // Setup mobile tabbar
  mountMobileTabbar();
}

/* ================== Auto-hydrate responsive tables ================== */
(function observeResponsiveTables() {
  const observer = new MutationObserver(() => {
    Promise.resolve().then(() => {
      if (window.hydrateResponsiveTables) window.hydrateResponsiveTables();
    });
  });
  observer.observe(document.body, { childList: true, subtree: true });
})();

/* ================== Start Application ================== */
document.addEventListener('DOMContentLoaded', initializeApp);
if (document.readyState !== 'loading') {
  initializeApp();
}

</script>
</body>
</html>
